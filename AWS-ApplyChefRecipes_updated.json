{
    "schemaVersion": "2.2",
    "description": "Use this document to run Chef recipes on AWS Systems Manager managed instances.",
    "parameters": {
        "SourceType": {
            "description": "(Required) The source repository type for your Chef cookbooks.",
            "type": "String",
            "allowedValues": [
                "GitHub",
                "S3"
            ],
            "default": "S3"
        },
        "SourceInfo": {
            "description": "(Required) Information about the source repository, such as repository name, owner, branch if on GitHub, or path if Amazon S3. If source type is GitHub, you can specify any of the following: 'owner', 'repository', 'path', 'getOptions', 'tokenInfo'. If source type is S3, you can specify 'path'. Example GitHub parameters: {\"owner\":\"awslabs\",\"repository\":\"amazon-ssm\",\"path\":\"Compliance/InSpec/PortCheck\",\"getOptions\":\"branch:master\"}.",
            "type": "StringMap",
            "displayType": "textarea",
            "default": {
                "path": "https://aws-applychefrecipes-examples.s3.amazonaws.com/apply-chef-recipes-example-cookbook.tar.gz"
            }
        },
        "RunList": {
            "type": "String",
            "description": "(Required) The Chef recipes to apply. For example, recipe[cookbook_name1::recipe_name],recipe[cookbook_name2::recipe_name]",
            "allowedPattern": "^(recipe\\[[^'\";&\\|><\\*\\?`\\$\\(\\)\\{\\}\\[\\]!#\\\\]+\\])(\\,recipe\\[[^'\";&\\|><\\*\\?`\\$\\(\\)\\{\\}\\[\\]!#\\\\]+\\])*$",
            "default": "recipe[apply-chef-recipes-example-cookbook::default]"
        },
        "JsonAttributesContent": {
            "description": "(Optional) Attributes JSON to pass to the Chef client that applies your recipes.",
            "type": "String",
            "displayType": "textarea",
            "default": "{\"filepath\":\"/tmp/example.txt\", \"content\":\"Hello, World!\"}"
        },
        "ChefClientVersion": {
            "type": "String",
            "description": "(Optional) The Chef client version to install on instances before recipes are applied. If None is specified, Systems Manager does not install the Chef client before applying your recipes.",
            "default": "14",
            "allowedValues": [
                "None",
                "11",
                "12",
                "13",
                "14",
                "15",
                "16",
                "17"
            ]
        },
        "ChefClientArguments": {
            "type": "String",
            "description": "(Optional) Extra arguments to be passed to the Chef client that applies your recipes. For more information about available arguments, run chef-client -h from an instance that has the Chef client installed.",
            "default": "",
            "allowedPattern": "^[^'\";&\\|><\\*\\?`\\$\\(\\)\\{\\}\\[\\]!#\\\\]*$"
        },
        "WhyRun": {
            "type": "String",
            "description": "(Optional) When set to true, enables why-run mode, which shows what will happen if the recipes are run, but does not modify target instances.",
            "allowedValues": [
                "True",
                "False"
            ],
            "default": "False"
        },
        "ComplianceSeverity": {
            "type": "String",
            "description": "(Optional) The severity of drift between your Chef recipes and instance resources that is shown in Systems Manager compliance reports. To skip compliance reporting, specify None.",
            "allowedValues": [
                "None",
                "Critical",
                "High",
                "Medium",
                "Low",
                "Informational",
                "Unspecified"
            ],
            "default": "None"
        },
        "ComplianceType": {
            "type": "String",
            "description": "(Optional) The compliance type that you want reported in compliance results.",
            "default": "Custom:Chef",
            "allowedPattern": "^$|^Custom\\:[a-zA-Z0-9\\-_\\.]{1,93}$"
        },
        "ComplianceReportBucket": {
            "type": "String",
            "description": "(Optional) The name of an existing Amazon S3 bucket in which to store details about every Chef run executed by this document, including resource configuration and compliance results.",
            "default": "",
            "allowedPattern": "^[^'\";&\\|><\\*\\?`\\$\\(\\)\\{\\}\\[\\]!#\\\\]*$"
        }
    },
    "mainSteps": [
        {
            "action": "aws:downloadContent",
            "name": "downloadCookbooks",
            "inputs": {
                "SourceType": "{{ SourceType }}",
                "SourceInfo": "{{ SourceInfo }}",
                "destinationPath": "customer_cookbooks"
            }
        },
        {
            "action": "aws:runShellScript",
            "name": "setCustomJson",
            "precondition": {
                "StringEquals": [
                    "platformType",
                    "Linux"
                ]
            },
            "inputs": {
                "runCommand": [
                    "#!/bin/bash",
                    "# MIT No Attribution",
                    "#",
                    "# Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.",
                    "#",
                    "# Permission is hereby granted, free of charge, to any person obtaining a copy of this",
                    "# software and associated documentation files (the \"Software\"), to deal in the Software",
                    "# without restriction, including without limitation the rights to use, copy, modify,",
                    "# merge, publish, distribute, sublicense, and/or sell copies of the Software, and to",
                    "# permit persons to whom the Software is furnished to do so.",
                    "#",
                    "# THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,",
                    "# INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A",
                    "# PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT",
                    "# HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION",
                    "# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE",
                    "# SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.",
                    "#",
                    "",
                    "set -e",
                    "",
                    "function report_error() {",
                    "    echo \"ERROR: $*\" 1>&2",
                    "}",
                    "",
                    "function throw_error() {",
                    "    report_error \"$*\"",
                    "    exit 1",
                    "}",
                    "",
                    "if [[ -z ${BASH_SOURCE[0]} ]]; then",
                    "    throw_error \"Bash script source is empty.\"",
                    "fi",
                    "",
                    "if [[ ! -x \"$(command -v awk)\" ]]; then",
                    "    throw_error \"awk is not installed.\"",
                    "fi",
                    "",
                    "< \"${BASH_SOURCE[0]}\" awk -v RS='^$' -F 'AWSAPPLYCHEF_RECIPES_JSONDELIM' '{print $3}' >json_attributes.json",
                    "exit 0",
                    "",
                    "AWSAPPLYCHEF_RECIPES_JSONDELIM{{ JsonAttributesContent }}"
                ]
            }
        },
        {
            "action": "aws:runPowerShellScript",
            "name": "setCustomJsonWindows",
            "precondition": {
                "StringEquals": [
                    "platformType",
                    "Windows"
                ]
            },
            "inputs": {
                "runCommand": [
                    "#!/bin/bash",
                    "# MIT No Attribution",
                    "#",
                    "# Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.",
                    "#",
                    "# Permission is hereby granted, free of charge, to any person obtaining a copy of this",
                    "# software and associated documentation files (the \"Software\"), to deal in the Software",
                    "# without restriction, including without limitation the rights to use, copy, modify,",
                    "# merge, publish, distribute, sublicense, and/or sell copies of the Software, and to",
                    "# permit persons to whom the Software is furnished to do so.",
                    "#",
                    "# THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,",
                    "# INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A",
                    "# PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT",
                    "# HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION",
                    "# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE",
                    "# SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.",
                    "#",
                    "",
                    "",
                    "function report_error($message) {",
                    "    echo \"ERROR: $message\" 2>&1",
                    "}",
                    "",
                    "function throw_error($message) {",
                    "    report_error \"$message\"",
                    "    exit 1",
                    "}",
                    "",
                    "$PS_SCRIPT_NAME=$MyInvocation.MyCommand.Name",
                    "$DELIMITER='AWSAPPLYCHEF_RECIPES_JSONDELIM'",
                    "try{",
                    "   (Select-String -Path \"$PSScriptRoot\\$PS_SCRIPT_NAME\"-Pattern \"$DELIMITER\")[-1].Line.Replace(\"$DELIMITER\",'').Replace('\\','\\\\').Trim(\"'\") | Out-File json_attribs.json -Encoding UTF8",
                    "   $utf8 = New-Object System.Text.UTF8Encoding $false",
                    "   $json_attr_path = 'json_attribs.json'",
                    "   $json_attr_cont = Get-Content $json_attr_path -Raw",
                    "   Set-Content -Value $utf8.GetBytes($json_attr_cont) -Encoding Byte -Path $json_attr_path",
                    "}",
                    "catch{",
                    "   throw_error \"Can't create json_attribs.json file.\"",
                    "}",
                    "",
                    "exit 0",
                    "AWSAPPLYCHEF_RECIPES_JSONDELIM'{{ JsonAttributesContent }}'"
                ]
            }
        },
        {
            "action": "aws:runShellScript",
            "name": "runShellScript",
            "precondition": {
                "StringEquals": [
                    "platformType",
                    "Linux"
                ]
            },
            "inputs": {
                "runCommand": [
                    "#!/bin/bash",
                    "# MIT No Attribution",
                    "#",
                    "# Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.",
                    "#",
                    "# Permission is hereby granted, free of charge, to any person obtaining a copy of this",
                    "# software and associated documentation files (the \"Software\"), to deal in the Software",
                    "# without restriction, including without limitation the rights to use, copy, modify,",
                    "# merge, publish, distribute, sublicense, and/or sell copies of the Software, and to",
                    "# permit persons to whom the Software is furnished to do so.",
                    "#",
                    "# THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,",
                    "# INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A",
                    "# PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT",
                    "# HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION",
                    "# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE",
                    "# SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.",
                    "#",
                    "",
                    "set -e",
                    "",
                    "SSM_CHEF_EXECUTION_BASE_DIR=\"$(pwd)\"",
                    "export SSM_CHEF_EXECUTION_BASE_DIR",
                    "export SSM_CHEF_SOURCE_TYPE=\"{{ SourceType }}\"",
                    "export SSM_CHEF_RUN_LIST=\"{{ RunList }}\"",
                    "export SSM_CHEF_WHY_RUN=\"{{ WhyRun }}\"",
                    "export SSM_CHEF_CLIENT_ARGUMENTS=({{ ChefClientArguments }})",
                    "export SSM_CHEF_CLIENT_VERSION=\"{{ ChefClientVersion }}\"",
                    "export SSM_CHEF_COMPLIANCE_SEVERITY=\"{{ ComplianceSeverity }}\"",
                    "export SSM_CHEF_COMPLIANCE_TYPE=\"{{ ComplianceType }}\"",
                    "export SSM_CHEF_COMPLIANCE_REPORT_BUCKET=\"{{ ComplianceReportBucket }}\"",
                    "",
                    "CHEF_RUN_LOCK_DIR=\"/tmp/aws/chef_run_locks\"",
                    "CHEF_RUN_LOCK_FILE=\"$CHEF_RUN_LOCK_DIR/aws-apply-chef-recipes.lock\"",
                    "SSM_CHEF_RUN_ASSETS_BUCKET=\"aws-ssm-$AWS_SSM_REGION_NAME\"",
                    "COMPLIANCE_REPORT_COOKBOOK_SHA_256=\"7bd335b078fd8cf68d8b36d164165b5e0d33eb9d53cb6ec8e309abec11181fe4\"",
                    "",
                    "function report_info() {",
                    "    echo \"INFO: $*\"",
                    "}",
                    "",
                    "function report_warning() {",
                    "    echo \"WARNING: $*\"",
                    "}",
                    "",
                    "function report_error() {",
                    "    echo \"ERROR: $*\" 1>&2",
                    "}",
                    "",
                    "function throw_error() {",
                    "    report_error \"$*\"",
                    "    exit 1",
                    "}",
                    "",
                    "function get_installed_chef_version() {",
                    "    local chef_version",
                    "    chef_version=$(chef-client --version) || true",
                    "    echo \"$chef_version\" | grep -E -o '[0-9]+\\.[0-9]+\\.[0-9]+'",
                    "}",
                    "",
                    "function get_installed_chef_major_version() {",
                    "    local chef_version",
                    "    chef_version=$(get_installed_chef_version)",
                    "    if [[ -z \"$chef_version\" ]]; then",
                    "        throw_error \"Chef client is not installed. Install Chef client and then run the command again.\"",
                    "    fi",
                    "",
                    "    echo \"$chef_version\" | grep -E -o '^[0-9]+'",
                    "}",
                    "",
                    "function validate_certificate() {",
                    "    if [ -e /opt/chef/embedded/ssl/cert.pem ]; then",
                    "        (grep -qxF 'DST Root CA X3' /opt/chef/embedded/ssl/cert.pem && sudo sed -i '/DST Root CA X3/,+19d' /opt/chef/embedded/ssl/cert.pem);",
                    "        (grep -qxF 'ISRG Root X1' /opt/chef/embedded/ssl/cert.pem || printf '\nISRG Root X1\n============\n-----BEGIN CERTIFICATE-----\nMIIFazCCA1OgAwIBAgIRAIIQz7DSQONZRGPgu2OCiwAwDQYJKoZIhvcNAQELBQAwTzELMAkGA1UE\nBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2VhcmNoIEdyb3VwMRUwEwYDVQQD\nEwxJU1JHIFJvb3QgWDEwHhcNMTUwNjA0MTEwNDM4WhcNMzUwNjA0MTEwNDM4WjBPMQswCQYDVQQG\nEwJVUzEpMCcGA1UEChMgSW50ZXJuZXQgU2VjdXJpdHkgUmVzZWFyY2ggR3JvdXAxFTATBgNVBAMT\nDElTUkcgUm9vdCBYMTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAK3oJHP0FDfzm54r\nVygch77ct984kIxuPOZXoHj3dcKi/vVqbvYATyjb3miGbESTtrFj/RQSa78f0uoxmyF+0TM8ukj1\n3Xnfs7j/EvEhmkvBioZxaUpmZmyPfjxwv60pIgbz5MDmgK7iS4+3mX6UA5/TR5d8mUgjU+g4rk8K\nb4Mu0UlXjIB0ttov0DiNewNwIRt18jA8+o+u3dpjq+sWT8KOEUt+zwvo/7V3LvSye0rgTBIlDHCN\nAymg4VMk7BPZ7hm/ELNKjD+Jo2FR3qyHB5T0Y3HsLuJvW5iB4YlcNHlsdu87kGJ55tukmi8mxdAQ\n4Q7e2RCOFvu396j3x+UCB5iPNgiV5+I3lg02dZ77DnKxHZu8A/lJBdiB3QW0KtZB6awBdpUKD9jf\n1b0SHzUvKBds0pjBqAlkd25HN7rOrFleaJ1/ctaJxQZBKT5ZPt0m9STJEadao0xAH0ahmbWnOlFu\nhjuefXKnEgV4We0+UXgVCwOPjdAvBbI+e0ocS3MFEvzG6uBQE3xDk3SzynTnjh8BCNAw1FtxNrQH\nusEwMFxIt4I7mKZ9YIqioymCzLq9gwQbooMDQaHWBfEbwrbwqHyGO0aoSCqI3Haadr8faqU9GY/r\nOPNk3sgrDQoo//fb4hVC1CLQJ13hef4Y53CIrU7m2Ys6xt0nUW7/vGT1M0NPAgMBAAGjQjBAMA4G\nA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBR5tFnme7bl5AFzgAiIyBpY\n9umbbjANBgkqhkiG9w0BAQsFAAOCAgEAVR9YqbyyqFDQDLHYGmkgJykIrGF1XIpu+ILlaS/V9lZL\nubhzEFnTIZd+50xx+7LSYK05qAvqFyFWhfFQDlnrzuBZ6brJFe+GnY+EgPbk6ZGQ3BebYhtF8GaV\n0nxvwuo77x/Py9auJ/GpsMiu/X1+mvoiBOv/2X/qkSsisRcOj/KKNFtY2PwByVS5uCbMiogziUwt\nhDyC3+6WVwW6LLv3xLfHTjuCvjHIInNzktHCgKQ5ORAzI4JMPJ+GslWYHb4phowim57iaztXOoJw\nTdwJx4nLCgdNbOhdjsnvzqvHu7UrTkXWStAmzOVyyghqpZXjFaH3pO3JLF+l+/+sKAIuvtd7u+Nx\ne5AW0wdeRlN8NwdCjNPElpzVmbUq4JUagEiuTDkHzsxHpFKVK7q4+63SM1N95R1NbdWhscdCb+ZA\nJzVcoyi3B43njTOQ5yOf+1CceWxG1bQVs5ZufpsMljq4Ui0/1lvh+wjChP4kqKOJ2qxq4RgqsahD\nYVvTH9w7jXbyLeiNdd8XM2w9U/t7y0Ff/9yi0GE44Za4rF2LN9d11TPAmRGunUHBcnWEvgJBQl9n\nJEiU0Zsnvgc/ubhPgXRR4Xq37Z0j4r7g1SgEEzwxA57demyPxgcYxn/eR44/KJ4EBs+lVDR3veyJ\nm+kXQ99b21/+jh5Xos1AnX5iItreGCc=\n-----END CERTIFICATE-----\n' | sudo tee -a /opt/chef/embedded/ssl/cert.pem);",
                    "        if (! grep -qxF 'DST Root CA X3' /opt/chef/embedded/ssl/cert.pem && grep -qxF 'ISRG Root X1' /opt/chef/embedded/ssl/cert.pem); then",
                    "            echo \"Lets Encrypt certificate fixed\"",
                    "        fi",
                    "    fi",
                    "}",
                    "",
                    "function validate_compliance_parameters() {",
                    "    if [[ -z \"$SSM_CHEF_COMPLIANCE_SEVERITY\" ]]; then",
                    "        throw_error \"ComplianceSeverity cannot be empty. Use 'None' to skip compliance reporting.\"",
                    "    fi",
                    "",
                    "    if [[ \"$SSM_CHEF_COMPLIANCE_SEVERITY\" == \"None\" ]]; then",
                    "        if [[ -n \"$SSM_CHEF_COMPLIANCE_REPORT_BUCKET\" ]]; then",
                    "            report_warning \"Compliance reports S3 bucket is set, but compliance severity is set to 'None'. No compliance reports will be generated.\"",
                    "        fi",
                    "",
                    "        if [[ -n \"$SSM_CHEF_COMPLIANCE_TYPE\" ]]; then",
                    "            report_warning \"Compliance type is not empty but compliance severity is set to 'None'. No compliance reports will be generated.\"",
                    "        fi",
                    "    else",
                    "        if [[ -z \"$SSM_CHEF_COMPLIANCE_REPORT_BUCKET\" ]]; then",
                    "            report_info \"ComplianceReportBucket is not set. Sending the compliance report to S3 will be skipped.\"",
                    "        fi",
                    "",
                    "        if [[ -z \"$SSM_CHEF_COMPLIANCE_TYPE\" ]]; then",
                    "            throw_error \"ComplianceType is not set. ComplianceType must be set when ComplianceSeverity is not 'None'.\"",
                    "        fi",
                    "",
                    "        if [[ \"$SSM_CHEF_CLIENT_VERSION\" != \"None\" ]] && [[ \"$SSM_CHEF_CLIENT_VERSION\" -le 11 ]]; then",
                    "            throw_error \"Compliance reporting is supported for Chef client versions 12 and newer. Set the compliance severity to 'None'.\"",
                    "        elif [[ \"$SSM_CHEF_CLIENT_VERSION\" == \"None\" ]]; then",
                    "            local chef_version",
                    "            chef_version=$(get_installed_chef_major_version) || chef_version=\"\"",
                    "",
                    "            if [[ -n \"$chef_version\" ]] && [[ \"$chef_version\" -le 11 ]]; then",
                    "                throw_error \"Compliance reporting is supported for Chef client versions 12 and newer. Set the compliance severity to 'None'.\"",
                    "            fi",
                    "        fi",
                    "    fi",
                    "}",
                    "",
                    "function validate_folder_checksums() {",
                    "    local folder=\"$1\"",
                    "    local sha_256_checksum=\"$2\"",
                    "",
                    "    if [[ ! -x \"$(command -v sha256sum)\" ]]; then",
                    "        throw_error \"Failed to verify checksum. sha256sum is not installed.\"",
                    "    fi",
                    "",
                    "    if [[ ! -x \"$(command -v realpath)\" ]]; then",
                    "        throw_error \"Failed to verify checksum. realpath is not installed.\"",
                    "    fi",
                    "",
                    "    if [[ ! -x \"$(command -v sort)\" ]]; then",
                    "        throw_error \"Failed to verify checksum. sort is not installed.\"",
                    "    fi",
                    "",
                    "    (",
                    "        local folder_full_path",
                    "        folder_full_path=$(realpath \"$folder\") || throw_error \"Failed to get full path for $folder\"",
                    "",
                    "        cd \"$folder_full_path\"",
                    "",
                    "        local dir_check_sum",
                    "        dir_check_sum=$(find \"$folder_full_path\" -type f -exec realpath --relative-to \"$folder_full_path\" {} \\; |",
                    "            sort -s -f | xargs -n1 sha256sum | sha256sum) || throw_error \"An error has occurred during checksum calculation.\"",
                    "        if [[ \"$dir_check_sum\" != \"$sha_256_checksum  -\" ]]; then",
                    "            throw_error \"Checksum verification for $folder_full_path failed.\"",
                    "        fi",
                    "    ) || throw_error \"Failed to validate checksum for $folder.\"",
                    "}",
                    "",
                    "function download_file() {",
                    "    local url=\"$1\"",
                    "    local destination=\"$2\"",
                    "",
                    "    if [[ -x \"$(command -v curl)\" ]]; then",
                    "        curl -L -o \"$destination\" \"$url\" || throw_error \"Failed to download file. curl exited with $?.\"",
                    "        return",
                    "    fi",
                    "",
                    "    if [[ -x \"$(command -v wget)\" ]]; then",
                    "        wget -O \"$destination\" \"$url\" || throw_error \"Failed to download file. wget exited with $?.\"",
                    "        return",
                    "    fi",
                    "",
                    "    throw_error \"Failed to download file. Neither curl nor wget are installed.\"",
                    "}",
                    "",
                    "function download_from_s3() {",
                    "    local bucket_name=\"$1\"",
                    "    local keyname=\"$2\"",
                    "    local destination=\"$3\"",
                    "    local url=\"\"",
                    "",
                    "    if [[ \"$AWS_SSM_REGION_NAME\" == cn-* ]]; then",
                    "        url=\"https://s3.$AWS_SSM_REGION_NAME.amazonaws.com.cn/$bucket_name/$keyname\"",
                    "    elif [[ \"$AWS_SSM_REGION_NAME\" == us-gov-* ]]; then",
                    "        url=\"https://s3-fips-$AWS_SSM_REGION_NAME.amazonaws.com/$bucket_name/$keyname\"",
                    "    elif [[ \"$AWS_SSM_REGION_NAME\" == \"us-east-1\" ]]; then",
                    "        url=\"https://s3.amazonaws.com/$bucket_name/$keyname\"",
                    "    else",
                    "        url=\"https://s3-$AWS_SSM_REGION_NAME.amazonaws.com/$bucket_name/$keyname\"",
                    "    fi",
                    "",
                    "    download_file \"$url\" \"$destination\"",
                    "}",
                    "",
                    "function should_install_chef() {",
                    "    if [[ \"$SSM_CHEF_CLIENT_VERSION\" == \"None\" ]] || [[ -z \"$SSM_CHEF_CLIENT_VERSION\" ]]; then",
                    "        return 1",
                    "    fi",
                    "",
                    "    if [[ -z \"$(command -V chef-client 2>/dev/null)\" ]] || different_chef_version_installed; then",
                    "        return 0",
                    "    else",
                    "        return 1",
                    "    fi",
                    "}",
                    "",
                    "function get_fully_qualified_chef_version() {",
                    "    if [[ \"$SSM_CHEF_CLIENT_VERSION\" == \"11\" ]]; then",
                    "        echo \"11.18.12\"",
                    "    elif [[ \"$SSM_CHEF_CLIENT_VERSION\" == \"12\" ]]; then",
                    "        echo \"12.22.5\"",
                    "    elif [[ \"$SSM_CHEF_CLIENT_VERSION\" == \"13\" ]]; then",
                    "        echo \"13.12.14\"",
                    "    elif [[ \"$SSM_CHEF_CLIENT_VERSION\" == \"14\" ]]; then",
                    "        echo \"14.15.6\"",
                    "    elif [[ \"$SSM_CHEF_CLIENT_VERSION\" == \"15\" ]]; then",
                    "        echo \"15.17.4\"",
                    "    elif [[ \"$SSM_CHEF_CLIENT_VERSION\" == \"16\" ]]; then",
                    "        echo \"16.17.18\"",
                    "    elif [[ \"$SSM_CHEF_CLIENT_VERSION\" == \"17\" ]]; then",
                    "        echo \"17.9.26\"",
                    "    fi",
                    "}",
                    "",
                    "function different_chef_version_installed() {",
                    "    local installed_chef_version",
                    "    installed_chef_version=$(get_installed_chef_version)",
                    "",
                    "    local user_requested_version",
                    "    user_requested_version=\"$(get_fully_qualified_chef_version)\"",
                    "",
                    "    if [[ \"$installed_chef_version\" == \"$user_requested_version\" ]]; then",
                    "        return 1",
                    "    else",
                    "        return 0",
                    "    fi",
                    "}",
                    "",
                    "function install_chef() {",
                    "    if should_install_chef; then",
                    "        download_file \"https://omnitruck.chef.io/install.sh\" \"$SSM_CHEF_EXECUTION_BASE_DIR/install-chef.sh\"",
                    "        sudo bash \"$SSM_CHEF_EXECUTION_BASE_DIR/install-chef.sh\" -d \"/opt/aws/chef-binaries-cache\" -v \"$(get_fully_qualified_chef_version)\"",
                    "",
                    "        if [[ ! -x \"$(command -v chef-client)\" ]]; then",
                    "            # On SUSE Enterprise Linux the installation sometimes succeeds but fails internally. The following performs a reinstallation in this case",
                    "            sudo bash \"$SSM_CHEF_EXECUTION_BASE_DIR/install-chef.sh\" -d \"/opt/aws/chef-binaries-cache\" -v \"$(get_fully_qualified_chef_version)\"",
                    "        fi",
                    "    fi",
                    "}",
                    "",
                    "function validate_installed_chef_version() {",
                    "    local chef_version",
                    "    chef_version=$(get_installed_chef_major_version) || throw_error \"Failed to get the Chef client version.\"",
                    "",
                    "    if [[ \"$chef_version\" -gt \"17\" ]]; then",
                    "        throw_error \"Chef client version $(get_installed_chef_version) is not supported. Only versions 17 and older are supported.\"",
                    "    fi",
                    "}",
                    "",
                    "function validate_run_list() {",
                    "    if [[ -z \"$SSM_CHEF_RUN_LIST\" ]]; then",
                    "        throw_error \"Run list is empty. The Chef client cannot run. Use the RunList parameter to specify recipes to run. For example: \\\"recipe[cb1::recipe_name],recipe[cb2::recipe]\\\"\"",
                    "    fi",
                    "}",
                    "",
                    "function obtain_compliance_reporter_cookbook() {",
                    "    if [[ \"$SSM_CHEF_COMPLIANCE_SEVERITY\" == \"None\" ]]; then",
                    "        return",
                    "    fi",
                    "",
                    "    (",
                    "        cd \"$SSM_CHEF_EXECUTION_BASE_DIR\"",
                    "        download_from_s3 \"$SSM_CHEF_RUN_ASSETS_BUCKET\" \"statemanagerdocumentspayload/AWS-ApplyChefRecipes/aws-ssm-cookbooks-v0.1.tar.gz\" \"aws-ssm-cookbooks.tar.gz\"",
                    "        mkdir -p \"aws-ssm-cookbooks\"",
                    "        tar xf \"aws-ssm-cookbooks.tar.gz\" --strip-components=1 -C \"aws-ssm-cookbooks\"",
                    "        validate_folder_checksums \"aws-ssm-cookbooks\" \"$COMPLIANCE_REPORT_COOKBOOK_SHA_256\"",
                    "    ) || exit $?",
                    "",
                    "    echo \"$SSM_CHEF_EXECUTION_BASE_DIR/aws-ssm-cookbooks/cookbooks/\"",
                    "    return",
                    "}",
                    "",
                    "function extract_cookbooks() {",
                    "    local archive=\"$1\"",
                    "    local destination=\"$2\"",
                    "",
                    "    mkdir -p \"$destination\"",
                    "",
                    "    if (tar xf \"$archive\" -C \"$destination\" >/dev/null); then",
                    "        return",
                    "    fi",
                    "",
                    "    report_error \"Cookbooks could not be extracted with tar. Trying with unzip...\"",
                    "",
                    "    if [[ ! -x \"$(command -v unzip)\" ]]; then",
                    "        throw_error \"'unzip' is not installed. Failed to extract cookbooks.\"",
                    "    fi",
                    "",
                    "    if (unzip -o \"$archive\" -d \"$destination\" >/dev/null); then",
                    "        return",
                    "    fi",
                    "",
                    "    throw_error \"Failed to extract the cookbooks with 'unzip'. The file should be a compressed tarball (.tar.gz) or a zip file (.zip).\"",
                    "}",
                    "",
                    "function extract_downloaded_customer_cookbooks() {",
                    "    if [[ -z \"$SSM_CHEF_SOURCE_TYPE\" ]]; then",
                    "        throw_error \"Cookbook source type must not be empty.\"",
                    "    fi",
                    "",
                    "    if [[ -f \"$SSM_CHEF_EXECUTION_BASE_DIR/customer_cookbooks\" ]]; then",
                    "        extract_cookbooks \"$SSM_CHEF_EXECUTION_BASE_DIR/customer_cookbooks\" \"$SSM_CHEF_EXECUTION_BASE_DIR/customer_cookbooks_extracted\"",
                    "    elif [[ -d \"$SSM_CHEF_EXECUTION_BASE_DIR/customer_cookbooks\" ]]; then",
                    "        mv \"$SSM_CHEF_EXECUTION_BASE_DIR/customer_cookbooks\" \"$SSM_CHEF_EXECUTION_BASE_DIR/customer_cookbooks_extracted/\" >/dev/null",
                    "    fi",
                    "",
                    "    if [[ -d \"$SSM_CHEF_EXECUTION_BASE_DIR/customer_cookbooks_extracted/cookbooks/\" ]]; then",
                    "        echo \"$SSM_CHEF_EXECUTION_BASE_DIR/customer_cookbooks_extracted/cookbooks/\"",
                    "    else",
                    "        echo \"$SSM_CHEF_EXECUTION_BASE_DIR/customer_cookbooks_extracted/\"",
                    "    fi",
                    "}",
                    "",
                    "function generate_config_rb() {",
                    "    local customer_cookbooks_location=\"$1\"",
                    "    local compliance_report_cookbooks_location=\"$2\"",
                    "",
                    "    (",
                    "        cd \"$SSM_CHEF_EXECUTION_BASE_DIR\"",
                    "        {",
                    "            echo \"cookbook_path [\"",
                    "            if [[ \"$SSM_CHEF_COMPLIANCE_SEVERITY\" != \"None\" ]]; then",
                    "",
                    "                # Sanity check",
                    "                if [[ ! -d \"$compliance_report_cookbooks_location/aws-ssm-report-handler\" ]]; then",
                    "                    throw_error \"Compliance reporting cookbook is not present.\"",
                    "                fi",
                    "",
                    "                if [[ \"$(get_installed_chef_major_version)\" -ge \"12\" ]] && [[ \"$(get_installed_chef_major_version)\" -le \"13\" ]]; then",
                    "                    echo \"  '$compliance_report_cookbooks_location/3rd-party-cookbooks/chef12-13',\"",
                    "                fi",
                    "",
                    "                echo \"  '$compliance_report_cookbooks_location',\"",
                    "            fi",
                    "",
                    "            echo \"  '$customer_cookbooks_location'\"",
                    "            echo \"]\"",
                    "",
                    "            echo \"local_mode true\"",
                    "        } >>config.rb",
                    "",
                    "    ) || exit $?",
                    "}",
                    "",
                    "function execute_chef() {",
                    "    local customer_cookbooks_location=\"$1\"",
                    "    local compliance_report_cookbooks_location=\"$2\"",
                    "",
                    "    validate_installed_chef_version",
                    "    local json_attributes_argument=()",
                    "",
                    "    # Chef 14.11 and above needs the HOME variable to be set:",
                    "    if [[ -z $HOME ]]; then",
                    "        export HOME=\"$SSM_CHEF_EXECUTION_BASE_DIR\"",
                    "    fi",
                    "",
                    "    if [[ -f \"$SSM_CHEF_EXECUTION_BASE_DIR/json_attributes.json\" ]]; then",
                    "        if (grep -q '[^[:space:]]' \"$SSM_CHEF_EXECUTION_BASE_DIR/json_attributes.json\"); then",
                    "            json_attributes_argument=(--json-attributes \"$SSM_CHEF_EXECUTION_BASE_DIR/json_attributes.json\")",
                    "        fi",
                    "    fi",
                    "    generate_config_rb \"$customer_cookbooks_location\" \"$compliance_report_cookbooks_location\"",
                    "",
                    "    local chef_command_exit_code=0",
                    "    local install_compliance_gems_exit_code=0",
                    "    local why_run_exit_code=0",
                    "    # Make mutating run when why-run is not requested",
                    "    if [[ \"$SSM_CHEF_WHY_RUN\" != \"True\" ]]; then",
                    "        chef-client -c \"$SSM_CHEF_EXECUTION_BASE_DIR/config.rb\" \"${SSM_CHEF_CLIENT_ARGUMENTS[@]}\" \"${json_attributes_argument[@]}\" -o \"$SSM_CHEF_RUN_LIST\" --chef-license accept || chef_command_exit_code=$?",
                    "        if [[ \"$chef_command_exit_code\" != \"0\" ]]; then",
                    "            report_error \"User-specified recipes could not be run.\"",
                    "        else",
                    "            report_info \"User-specified recipes ran successfully.\"",
                    "        fi",
                    "    else",
                    "        report_info \"Skipping a mutating run because only 'why-run' was requested.\"",
                    "    fi",
                    "",
                    "    # Make why-run if requested or if compliance should be reported",
                    "    if [[ \"$SSM_CHEF_WHY_RUN\" == \"True\" ]] || [[ \"$SSM_CHEF_COMPLIANCE_SEVERITY\" != \"None\" ]]; then",
                    "        WHYRUN_CHEF_RUN_LIST=\"$SSM_CHEF_RUN_LIST\"",
                    "        if [[ \"$SSM_CHEF_COMPLIANCE_SEVERITY\" != \"None\" ]]; then",
                    "            report_info \"Installing required gems for compliance reporting...\"",
                    "",
                    "            # A mutating run is used to install required gems for compliance reporting",
                    "            chef-client -c \"$SSM_CHEF_EXECUTION_BASE_DIR/config.rb\" \"${SSM_CHEF_CLIENT_ARGUMENTS[@]}\" -o \"aws-ssm-report-handler::compliance-gems\" --chef-license accept || install_compliance_gems_exit_code=$?",
                    "            if [[ \"$install_compliance_gems_exit_code\" != \"0\" ]]; then",
                    "                report_error \"Failed to install compliance reporting gems. Compliance won't be reported.\"",
                    "            else",
                    "                report_info \"Performing compliance check with severity '$SSM_CHEF_COMPLIANCE_SEVERITY' in a why-run.\"",
                    "                WHYRUN_CHEF_RUN_LIST=\"aws-ssm-report-handler::compliance-handler,$WHYRUN_CHEF_RUN_LIST\"",
                    "            fi",
                    "        fi",
                    "",
                    "        # Performing the actual why-run",
                    "        SSM_CHEF_WHY_RUN=True chef-client -W -c \"$SSM_CHEF_EXECUTION_BASE_DIR/config.rb\" \"${SSM_CHEF_CLIENT_ARGUMENTS[@]}\" \"${json_attributes_argument[@]}\" -o \"$WHYRUN_CHEF_RUN_LIST\" --chef-license accept || why_run_exit_code=$?",
                    "        if [[ \"$why_run_exit_code\" != \"0\" ]]; then",
                    "            report_error \"Chef client execution failed.\"",
                    "        else",
                    "            report_info \"Chef client execution succeeded.\"",
                    "        fi",
                    "    fi",
                    "",
                    "    return $((chef_command_exit_code || why_run_exit_code || install_compliance_gems_exit_code))",
                    "}",
                    "",
                    "function main() {",
                    "",
                    "    validate_run_list",
                    "    validate_compliance_parameters",
                    "",
                    "    local compliance_report_cookbooks_location",
                    "    compliance_report_cookbooks_location=$(obtain_compliance_reporter_cookbook) || throw_error \"Failed to obtain compliance reporting cookbook.\"",
                    "",
                    "    local customer_cookbooks_location",
                    "    customer_cookbooks_location=$(extract_downloaded_customer_cookbooks) || throw_error \"Failed to extract or copy the user cookbook.\"",
                    "",
                    "    if should_install_chef; then",
                    "        report_info \"The requested Chef client version is not installed. Installing Chef client.\"",
                    "        install_chef || exit $?",
                    "    fi",
                    "",
                    "    validate_certificate",
                    "",
                    "    report_info \"Executing chef client...\"",
                    "    execute_chef \"$customer_cookbooks_location\" \"$compliance_report_cookbooks_location\" || exit $?",
                    "}",
                    "",
                    "mkdir -p \"$CHEF_RUN_LOCK_DIR\"",
                    "(",
                    "    set -e",
                    "    flock -e 200",
                    "    main || exit $?",
                    "",
                    ") 200>\"$CHEF_RUN_LOCK_FILE\" || exit $?"
                ]
            }
        },
        {
            "action": "aws:runPowerShellScript",
            "name": "runPowerShellScript",
            "precondition": {
                "StringEquals": [
                    "platformType",
                    "Windows"
                ]
            },
            "inputs": {
                "runCommand": [
                    "# MIT No Attribution",
                    "#",
                    "# Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.",
                    "#",
                    "# Permission is hereby granted, free of charge, to any person obtaining a copy of this",
                    "# software and associated documentation files (the \"Software\"), to deal in the Software",
                    "# without restriction, including without limitation the rights to use, copy, modify,",
                    "# merge, publish, distribute, sublicense, and/or sell copies of the Software, and to",
                    "# permit persons to whom the Software is furnished to do so.",
                    "#",
                    "# THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,",
                    "# INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A",
                    "# PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT",
                    "# HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION",
                    "# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE",
                    "# SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.",
                    "#",
                    "",
                    "",
                    "$SSM_CHEF_EXECUTION_BASE_DIR=$(pwd).Path",
                    "$SSM_CHEF_SOURCE_TYPE='{{SourceType}}'",
                    "$SSM_CHEF_RUN_LIST='{{RunList}}'",
                    "$SSM_CHEF_WHY_RUN='{{WhyRun}}'",
                    "$SSM_CHEF_CLIENT_ARGUMENTS='{{ChefClientArguments}}'.Split(' ')",
                    "$SSM_CHEF_CLIENT_VERSION='{{ChefClientVersion}}'",
                    "$SSM_CHEF_COMPLIANCE_SEVERITY='{{ComplianceSeverity}}'",
                    "$SSM_CHEF_COMPLIANCE_TYPE='{{ComplianceType}}'",
                    "$SSM_CHEF_COMPLIANCE_REPORT_BUCKET='{{ComplianceReportBucket}}'",
                    "",
                    "$CHEF_RUN_LOCK_DIR=\"$env:temp\\aws\\chef_run_locks\"",
                    "$CHEF_RUN_LOCK_FILE=\"$CHEF_RUN_LOCK_DIR\\aws-apply-chef-recipes.lock\"",
                    "$SSM_CHEF_RUN_ASSETS_BUCKET='aws-ssm-{0}' -f $env:AWS_SSM_REGION_NAME",
                    "$COMPLIANCE_REPORT_COOKBOOK_SHA_256=\"D0E25D6E09FF97D9BDD6A3C45E2DEE6ADA24813A2799BF46240EBD75C0085F3A\"",
                    "",
                    "function report_info($message) {",
                    "    echo \"INFO: $message\"",
                    "}",
                    "",
                    "function report_warning($message) {",
                    "    echo \"WARNING: $message\"",
                    "}",
                    "",
                    "function report_error($message) {",
                    "    echo \"ERROR: $message\" 2>&1",
                    "}",
                    "",
                    "function throw_error($message) {",
                    "    report_error \"$message\"",
                    "    exit 1",
                    "}",
                    "",
                    "function add_chef_path_to_environment_variable() {",
                    "    if (($env:Path | Select-String \"C:\\\\opscode\\\\chef\\\\bin\\\\;\").Length -eq 0){",
                    "       $env:Path += \";C:\\opscode\\chef\\bin;\"",
                    "    }",
                    "}",
                    "",
                    "function get_installed_chef_version() {",
                    "    try{",
                    "    $chef_version=$(chef-client --version)",
                    "    }",
                    "    catch{",
                    "    $chef_version=''",
                    "    }",
                    "    $version_regex='[\\d\\.]+'",
                    "    $matched_version=[Regex]::Matches($chef_version, $version_regex)",
                    "    echo $matched_version[0].Value",
                    "}",
                    "",
                    "function get_installed_chef_major_version() {",
                    "    $chef_version=$(get_installed_chef_version)",
                    "    if (!$chef_version) {",
                    "        throw_error \"Chef client is not installed. Install Chef client and then run the command again.\"",
                    "    }",
                    "",
                    "    echo $chef_version.Split('.')[0]",
                    "}",
                    "",
                    "function validate_compliance_parameters() {",
                    "    if (!$SSM_CHEF_COMPLIANCE_SEVERITY){ ",
                    "        throw_error \"ComplianceSeverity cannot be empty. Use 'None' to skip compliance reporting.\"",
                    "    }",
                    "",
                    "    if ($SSM_CHEF_COMPLIANCE_SEVERITY -eq \"None\") {",
                    "        if ($SSM_CHEF_COMPLIANCE_REPORT_BUCKET){",
                    "            report_warning \"Compliance reports S3 bucket is set, but compliance severity is set to 'None'. No compliance reports will be generated.\"",
                    "        }",
                    "",
                    "        if ($SSM_CHEF_COMPLIANCE_TYPE) {",
                    "            report_warning \"Compliance type is not empty but compliance severity is set to 'None'. No compliance reports will be generated.\"",
                    "        }",
                    "    }else {",
                    "        if (!$SSM_CHEF_COMPLIANCE_REPORT_BUCKET) {",
                    "            report_info \"ComplianceReportBucket is not set. Sending the compliance report to S3 will be skipped.\"",
                    "        }",
                    "",
                    "        if (!$SSM_CHEF_COMPLIANCE_TYPE) {",
                    "            throw_error \"ComplianceType is not set. ComplianceType must be set when ComplianceSeverity is not 'None'.\"",
                    "        }",
                    "",
                    "        if ($SSM_CHEF_CLIENT_VERSION -ne \"None\" -and $SSM_CHEF_CLIENT_VERSION -le 11) {",
                    "            throw_error \"Compliance reporting is supported for Chef client versions 12 and newer. Set the compliance severity to 'None'.\"",
                    "        }",
                    "        elseif ($SSM_CHEF_CLIENT_VERSION -eq \"None\") {",
                    "           try{",
                    "               $chef_version=$(get_installed_chef_major_version)",
                    "           }",
                    "           catch{",
                    "               $chef_version=''",
                    "           }",
                    "",
                    "           if ($chef_version -and $chef_version -le 11){",
                    "                throw_error \"Compliance reporting is supported for Chef client versions 12 and newer. Set the compliance severity to 'None'.\"",
                    "           }",
                    "        }",
                    "    }",
                    "}",
                    "",
                    "function validate_folder_checksums($folder,$sha_256_checksum) {",
                    "",
                    "    if (! (Get-Command Get-FileHash)) {",
                    "        throw_error \"Failed to verify checksum. Get-FileHash is not working.\"",
                    "    }",
                    "",
                    "    if (! (Get-Command Resolve-Path)) {",
                    "        throw_error \"Failed to verify checksum. Resolve-Path is not working.\"",
                    "    }",
                    "",
                    "    if (! (Get-Command Sort-Object)) {",
                    "        throw_error \"Failed to verify checksum. Sort-Object is not working.\"",
                    "    }",
                    "",
                    "    try{",
                    "        try{",
                    "             $folder_full_path=Resolve-Path $folder",
                    "        }",
                    "        catch{",
                    "             throw_error \"Failed to get full path for $folder\"",
                    "        }",
                    "",
                    "        subst X: $folder_full_path",
                    "        cd X:",
                    "",
                    "        try{",
                    "           $dir_check_sum1=Get-ChildItem -Path X: -Recurse -File | where {$_.FullName -notlike \"*\\nodes\\*\"}",
                    "           $dir_check_sum2=$dir_check_sum1 | Resolve-Path -Relative",
                    "           $dir_check_sum3=$dir_check_sum2 | Sort-Object",
                    "           $dir_check_sum4=Get-FileHash $dir_check_sum3",
                    "           $dir_check_sum=(Get-FileHash -InputStream ([System.IO.MemoryStream]::New([System.Text.Encoding]::UTF8.GetBytes($dir_check_sum4)))).Hash",
                    "           subst X: /d",
                    "        }",
                    "        catch{",
                    "           throw_error \"An error has occurred during checksum calculation.\"",
                    "        }",
                    "        if ( \"$dir_check_sum\" -ne \"$sha_256_checksum\") {",
                    "            throw_error \"Checksum verification for $folder_full_path failed.\"",
                    "        }",
                    "    }",
                    "    catch{",
                    "    throw_error \"Failed to validate checksum for $folder.\"",
                    "    }",
                    "}",
                    "",
                    "function download_file($url, $destination) {",
                    "",
                    "    try{",
                    "       Invoke-WebRequest -Uri $url -OutFile $destination",
                    "    }",
                    "    catch{",
                    "       throw_error \"Failed to download file.\"",
                    "    }",
                    "}",
                    "",
                    "function download_from_s3($bucket_name, $keyname, $destination) {",
                    "    $url=\"\"",
                    "",
                    "    if ($env:AWS_SSM_REGION_NAME.StartsWith('cn-')){",
                    "        $url=\"https://s3.$env:AWS_SSM_REGION_NAME.amazonaws.com.cn/$bucket_name/$keyname\"",
                    "    }",
                    "    elseif ($env:AWS_SSM_REGION_NAME.StartsWith('us-gov-')) {",
                    "        $url=\"https://s3-fips-$env:AWS_SSM_REGION_NAME.amazonaws.com/$bucket_name/$keyname\"",
                    "    }",
                    "    elseif ($env:AWS_SSM_REGION_NAME -eq \"us-east-1\") {",
                    "        $url=\"https://s3.amazonaws.com/$bucket_name/$keyname\"",
                    "    }",
                    "    else{",
                    "        $url=\"https://s3-$env:AWS_SSM_REGION_NAME.amazonaws.com/$bucket_name/$keyname\"",
                    "    }",
                    "",
                    "    download_file $url $destination",
                    "}",
                    "",
                    "function should_install_chef() {",
                    "    if ($SSM_CHEF_CLIENT_VERSION -eq \"None\" -or !$SSM_CHEF_CLIENT_VERSION) {",
                    "        return 0",
                    "    }",
                    "",
                    "    if (!(get_installed_chef_version) -or (different_chef_version_installed)) {",
                    "        return 1",
                    "    }",
                    "    else{",
                    "        return 0",
                    "    }",
                    "}",
                    "",
                    "function get_fully_qualified_chef_version() {",
                    "   switch ( $SSM_CHEF_CLIENT_VERSION )",
                    "   {",
                    "       \"11\" { echo \"11.18.12\"}",
                    "       \"12\" {echo \"12.22.5\"}",
                    "       \"13\" {echo \"13.12.14\"}",
                    "       \"14\" {echo \"14.15.6\"}",
                    "       \"15\" {echo \"15.17.4\"}",
                    "       \"16\" {echo \"16.17.18\"}",
                    "       \"17\" {echo \"17.9.26\"}",
                    "   }",
                    "}",
                    "",
                    "function different_chef_version_installed() {",
                    "    $installed_chef_version=$(get_installed_chef_version)",
                    "",
                    "    $user_requested_version=$(get_fully_qualified_chef_version)",
                    "",
                    "    if ( $installed_chef_version -eq $user_requested_version ){",
                    "        return 0",
                    "    }else{",
                    "        return 1",
                    "    }",
                    "}",
                    "",
                    "function install_chef() {",
                    "    if (get_installed_chef_version) {",
                    "       $installed_chef_major_version=get_installed_chef_major_version",
                    "       if ($SSM_CHEF_CLIENT_VERSION -lt $installed_chef_major_version){",
                    "           wmic product where \"Name like 'Chef Infra Client%%' or Name like 'Chef Client%%'\" call uninstall",
                    "       }",
                    "    }",
                    "    . { iwr -useb https://omnitruck.chef.io/install.ps1 } | iex; install -version \"$(get_fully_qualified_chef_version)\"",
                    "    ",
                    "}",
                    "",
                    "function validate_installed_chef_version() {",
                    "    try{",
                    "       $chef_version=$(get_installed_chef_major_version)",
                    "    }",
                    "    catch{",
                    "       throw_error \"Failed to get the Chef client version.\"",
                    "    }",
                    "",
                    "    if ($chef_version -gt \"17\"){",
                    "        throw_error \"Chef client version $(get_installed_chef_version) is not supported. Only versions 17 and older are supported.\"",
                    "    }",
                    "}",
                    "",
                    "function validate_run_list() {",
                    "    if (!$SSM_CHEF_RUN_LIST) {",
                    "        throw_error \"Run list is empty. The Chef client cannot run. Use the RunList parameter to specify recipes to run. For example: \\\"recipe[cb1::recipe_name],recipe[cb2::recipe]\\\"\"",
                    "    }",
                    "}",
                    "",
                    "function obtain_compliance_reporter_cookbook() {",
                    "    if ($SSM_CHEF_COMPLIANCE_SEVERITY -eq \"None\") {",
                    "        return",
                    "    }",
                    "",
                    "    try{",
                    "        cd $SSM_CHEF_EXECUTION_BASE_DIR",
                    "        download_from_s3 \"$SSM_CHEF_RUN_ASSETS_BUCKET\" \"statemanagerdocumentspayload\\AWS-ApplyChefRecipes/aws-ssm-cookbooks-v0.1.tar.gz\" \"aws-ssm-cookbooks.tar.gz\"",
                    "        New-Item -Name \"aws-ssm-cookbooks\" -ItemType \"directory\" | Out-Null",
                    "        tar xf \"aws-ssm-cookbooks.tar.gz\" --strip-components=1 -C \"aws-ssm-cookbooks\"",
                    "        validate_folder_checksums \"aws-ssm-cookbooks\" \"$COMPLIANCE_REPORT_COOKBOOK_SHA_256\"",
                    "    }",
                    "     catch{",
                    "        exit 1",
                    "    }",
                    "",
                    "    echo \"$SSM_CHEF_EXECUTION_BASE_DIR\\aws-ssm-cookbooks\\cookbooks\\\"",
                    "    return",
                    "}",
                    "",
                    "function extract_cookbooks($archive,$destination) {",
                    "",
                    "    if (!(test-path $destination)) {",
                    "        md \"$destination\" | Out-Null",
                    "    }",
                    "    cd $destination",
                    "",
                    "    try{",
                    "       tar -xf \"$archive\"",
                    "    }",
                    "    catch{",
                    "       throw_error \"Failed to extract the cookbooks with 'tar'. The file should be a compressed tarball (.tar.gz) or a zip file (.zip).\"",
                    "    }",
                    "}",
                    "",
                    "function extract_downloaded_customer_cookbooks() {",
                    "    if (!$SSM_CHEF_SOURCE_TYPE) {",
                    "        throw_error \"Cookbook source type must not be empty.\"",
                    "    }",
                    "",
                    "    if (test-path -Path \"$SSM_CHEF_EXECUTION_BASE_DIR\\customer_cookbooks\" -PathType leaf) {",
                    "        extract_cookbooks \"$SSM_CHEF_EXECUTION_BASE_DIR\\customer_cookbooks\" \"$SSM_CHEF_EXECUTION_BASE_DIR\\customer_cookbooks_extracted\"",
                    "    }",
                    "    elseif (test-path -Path \"$SSM_CHEF_EXECUTION_BASE_DIR\\customer_cookbooks\") {",
                    "        Move-Item \"$SSM_CHEF_EXECUTION_BASE_DIR\\customer_cookbooks\" \"$SSM_CHEF_EXECUTION_BASE_DIR\\customer_cookbooks_extracted\\\"",
                    "    }",
                    "",
                    "    if (test-path -Path \"$SSM_CHEF_EXECUTION_BASE_DIR\\customer_cookbooks_extracted\\cookbooks\\\") {",
                    "        echo \"$SSM_CHEF_EXECUTION_BASE_DIR\\customer_cookbooks_extracted\\cookbooks\\\"",
                    "    }else{",
                    "        echo \"$SSM_CHEF_EXECUTION_BASE_DIR\\customer_cookbooks_extracted\\\"",
                    "    }",
                    "}",
                    "",
                    "function generate_config_rb($cookbooks_location, $compliance_cookbooks_location) {",
                    "",
                    "    $customer_cookbooks_location_double_backslash=$cookbooks_location.Replace('\\','\\\\')",
                    "    if ($compliance_cookbooks_location) {$compliance_cookbooks_location_double_backslash=$compliance_cookbooks_location.Replace('\\','\\\\')}",
                    "",
                    "    try{",
                    "       cd \"$SSM_CHEF_EXECUTION_BASE_DIR\"",
                    "       New-Item config.rb -ItemType \"file\"",
                    "       echo \"cookbook_path [\" | Out-File config.rb -Encoding UTF8",
                    "       if ($SSM_CHEF_COMPLIANCE_SEVERITY -ne \"None\") {",
                    "           if(!(test-path (Join-Path -Path \"$compliance_cookbooks_location\" -ChildPath \"aws-ssm-report-handler\"))){",
                    "               throw_error \"Compliance reporting cookbook is not present.\"",
                    "           }",
                    "           if(get_installed_chef_major_version -ge \"12\" -and get_installed_chef_major_version -le \"13\"){",
                    "               echo \"  `\"$compliance_cookbooks_location_double_backslash\\\\3rd-party-cookbooks\\\\chef12-13`\" ,\" | Out-File config.rb -Append -Encoding UTF8",
                    "           }",
                    "           echo \"  `\"$compliance_cookbooks_location_double_backslash`\" ,\" | Out-File config.rb -Append -Encoding UTF8",
                    "           }",
                    "       echo \"  `\"$customer_cookbooks_location_double_backslash`\"\" | Out-File config.rb -Append -Encoding UTF8",
                    "       echo \"]\" | Out-File config.rb -Append -Encoding UTF8",
                    "",
                    "       echo \"local_mode true\" | Out-File config.rb -Append -Encoding UTF8",
                    "    }",
                    "    catch{",
                    "       exit 1",
                    "    }",
                    "}",
                    "",
                    "function execute_chef($customer_cookbooks_location,$compliance_report_cookbooks_location) {",
                    "",
                    "    validate_installed_chef_version",
                    "",
                    "    generate_config_rb \"$customer_cookbooks_location\" \"$compliance_report_cookbooks_location\"",
                    "",
                    "    # Make mutating run when why-run is not requested",
                    "    if ($SSM_CHEF_WHY_RUN -ne \"True\"){",
                    "       try{",
                    "           chef-client -c \"$SSM_CHEF_EXECUTION_BASE_DIR\\config.rb\" $SSM_CHEF_CLIENT_ARGUMENTS  -j \"$SSM_CHEF_EXECUTION_BASE_DIR\\json_attribs.json\" -o \"$SSM_CHEF_RUN_LIST\" --chef-license accept",
                    "           if (!$?) {",
                    "             throw_error \"User-specified recipes could not be run.\"",
                    "           }else{",
                    "             report_info \"User-specified recipes ran successfully.\"",
                    "           }",
                    "       }",
                    "       catch{",
                    "           throw_error \"User-specified recipes could not be run.\"",
                    "       }",
                    "    }else{",
                    "        report_info \"Skipping a mutating run because only 'why-run' was requested.\"",
                    "    }",
                    "",
                    "    # Make why-run if requested or if compliance should be reported",
                    "    if($SSM_CHEF_WHY_RUN -eq \"True\" -or $SSM_CHEF_COMPLIANCE_SEVERITY -ne \"None\"){",
                    "        $WHYRUN_CHEF_RUN_LIST=$SSM_CHEF_RUN_LIST",
                    "        if ($SSM_CHEF_COMPLIANCE_SEVERITY -ne \"None\"){",
                    "            report_info \"Installing required gems for compliance reporting...\"",
                    "",
                    "            # A mutating run is used to install required gems for compliance reporting",
                    "           try{",
                    "               chef-client -c \"$SSM_CHEF_EXECUTION_BASE_DIR\\config.rb\" $SSM_CHEF_CLIENT_ARGUMENTS -o \"aws-ssm-report-handler::compliance-gems\" --chef-license accept",
                    "               if (!$?) {",
                    "                   throw_error \"Failed to install compliance reporting gems. Compliance won't be reported.\"",
                    "               }else{",
                    "                   report_info \"Performing compliance check with severity '$SSM_CHEF_COMPLIANCE_SEVERITY' in a why-run.\"",
                    "                   $WHYRUN_CHEF_RUN_LIST=\"aws-ssm-report-handler::compliance-handler,$WHYRUN_CHEF_RUN_LIST\"",
                    "               }",
                    "           }",
                    "           catch{",
                    "               throw_error \"Failed to install compliance reporting gems. Compliance won't be reported.\"",
                    "           }",
                    "        }",
                    "",
                    "        # Performing the actual why-run",
                    "        try{",
                    "               chef-client -W -c \"$SSM_CHEF_EXECUTION_BASE_DIR\\config.rb\" $SSM_CHEF_CLIENT_ARGUMENTS -j \"$SSM_CHEF_EXECUTION_BASE_DIR\\json_attribs.json\" -o \"$WHYRUN_CHEF_RUN_LIST\" --chef-license accept",
                    "               if (!$?) {",
                    "                   throw_error \"Chef client execution failed.\"",
                    "               }else{",
                    "                   report_info \"Chef client execution succeeded.\"",
                    "               }",
                    "           }",
                    "           catch{",
                    "               throw_error \"Chef client execution failed.\"",
                    "        }",
                    "    }",
                    "",
                    "}",
                    "",
                    "function main() {",
                    "",
                    "    add_chef_path_to_environment_variable",
                    "    validate_run_list",
                    "    validate_compliance_parameters",
                    "",
                    "    if (should_install_chef) {",
                    "        report_info \"The requested Chef client version is not installed. Installing Chef client.\"",
                    "        try{",
                    "           install_chef",
                    "        }",
                    "        catch{",
                    "           throw_error \"Failed to install chef client.\"",
                    "        }",
                    "    }",
                    "",
                    "    try {",
                    "       $compliance_report_cookbooks_location=obtain_compliance_reporter_cookbook",
                    "    }",
                    "    catch{",
                    "       throw_error \"Failed to obtain compliance reporting cookbook.\"",
                    "    }",
                    "",
                    "",
                    "    try {",
                    "       $customer_cookbooks_location=extract_downloaded_customer_cookbooks",
                    "    }",
                    "    catch{",
                    "       throw_error \"Failed to extract or copy the user cookbook.\"",
                    "    }",
                    "",
                    "    report_info \"Executing chef client...\"",
                    "    try {",
                    "       execute_chef \"$customer_cookbooks_location\" \"$compliance_report_cookbooks_location\"",
                    "    }",
                    "    catch{",
                    "       throw_error \"Failed to execute chef client.\"",
                    "    }",
                    "}",
                    "",
                    "function invoke_action_with_mutex() {",
                    "",
                    "    $mutex=$null",
                    "",
                    "    try {",
                    "       $created_new=$false",
                    "       $mutex=New-Object System.Threading.Mutex($true, \"Global\\MainExecution\", [ref]$created_new)",
                    "       if (-not $created_new) {",
                    "           try {",
                    "               $mutex.WaitOne() | Out-Null",
                    "           }",
                    "           catch [System.Threading.AbandonedMutexException]{",
                    "               echo \"Another thread exit without releasing the mutex.\"",
                    "           }",
                    "       }",
                    "       Invoke-Command -ScriptBlock ${function:main} -NoNewScope",
                    "    }",
                    "    finally{",
                    "       if ($mutex -ne $null) {",
                    "           $mutex.ReleaseMutex()",
                    "           $mutex.Dispose()",
                    "       }",
                    "    }",
                    "}",
                    "",
                    "try {",
                    "   invoke_action_with_mutex",
                    "}",
                    "catch{",
                    "   exit ",
                    "}"
                ]
            }
        }
    ]
}